<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cópia do Death Rally so que ruim</title>
</head>

<body>
    <style id="style">
        * {
            margin: 0;
            overflow: hidden;
        }
    </style>
    <canvas id="canvas"></canvas>
    <script src="Entity.js"></script>
    <script src="Sounds.js"></script>
    <script src="Projectile.js"></script>
    <script src="Guns.js"></script>
    <script src="Car.js"></script>
    <script src="Hud.js"></script>
    <script src="Camera.js"></script>
    <script src="Buttons.js"></script>
    <script>
        let canvas = document.getElementById("canvas");
        canvas.width = innerWidth;
        canvas.height = innerHeight;
        let context = canvas.getContext("2d");
        context.fillStyle = 'gray'
        context.fillRect(0, 0, canvas.width, canvas.height);
        let keys = [];
        let carsKeys = 
        [   {left: 65, right: 68, up: 87, down: 83, frontShoot: 81, backShoot: 69}, 
            {left: 70, right: 72, up: 84, down: 71, frontShoot: 82, backShoot: 89}, 
            {left: 74, right: 76, up: 73, down: 75, frontShoot: 85, backShoot: 79}, 
            {left: 37, right: 39, up: 38, down: 40, frontShoot: 17, backShoot: 16}, 
        ];
        let sounds = new Sounds();
        let FPS = 30;
        let timer = setInterval(localStorage.room == "loop" ? loop : menu, 1000 / FPS);
        //let players;
        // let cameras;
        
        let cameras = [];
        let players = new Cars();
        let entities = players.list.concat([])
        for(let i = 0; (i < players.list.length); i++)
        {   cameras.push(new Camera(i))
        }
        
        let world = {pista: new Image(), width: 3621, height: 3027}
        world.pista.src = "imgs/backgrounds/pista_grande.png";
		const menu_background = new Image();
		menu_background.src = "imgs/backgrounds/bg.png";
        context.textAlign = "center";
        context.textBaseline = "middle";
        let pista = [];
        //so um array temporario pra pegar a posição dos pontos de colisão da pista
        //pontosPista.map((v) => "new Point("+v.x+", "+v.y+")").join(",")
        let playersQuantity = 2;
        let pontosPista = [new Point(967, 315),new Point(843, 320),new Point(727, 418),new Point(420, 726),new Point(402, 772),new Point(398, 1306),new Point(383, 1320),new Point(368, 1320),new Point(354, 1306),new Point(354, 266),new Point(995, 266),new Point(1019, 291),new Point(1021, 1387),new Point(1034, 1422),new Point(1059, 1457),new Point(1091, 1488),new Point(1128, 1507),new Point(1203, 1513),new Point(1459, 1513),new Point(1459, 1504),new Point(2510, 1504),new Point(2510, 1591),new Point(2307, 1592),new Point(2265, 1613),new Point(2216, 1663),new Point(2196, 1701),new Point(2190, 1709),new Point(2188, 1724),new Point(2188, 1730),new Point(2188, 2620),new Point(2185, 2637),new Point(2176, 2642),new Point(2155, 2647),new Point(1879, 2647),new Point(1859, 2627),new Point(1876, 2610),new Point(2187, 2610)];
        let buttons = [
            new SwitchRoomButton(innerWidth - innerWidth*.25, innerHeight/2-canvas.height*.3, "", "", "JOGAR", loop), 
            new PlayersButton(innerWidth - innerWidth*.25, innerHeight/2-canvas.height*.12, "", ""), 
            new SwitchRoomButton(innerWidth - innerWidth*.25, innerHeight/2+canvas.height*.06, "", "", "EQUIPAMENTOS", "equipaments"), 
            new SwitchRoomButton(innerWidth - innerWidth*.25, innerHeight/2+canvas.height*.25, "", "", "CONFIGURAÇÕES", "configurations")
        ];
        let MenuOptions = 0;
        let CarOptions = -1;
        let buttonsCanSwitch = 0;
        let buttonsSwitchLimit = 4;
        let mouse = 
        {   x: 0,
            y: 0,
            click: false,
            colliding: false,
            collide(obj)
            {   return (this.x >= obj.x && this.x <= obj.x+obj.width) 
                && (this.y >= obj.y && this.y <= obj.y+obj.height);
            }   
        }     
        //variavel temporaria de som para fazer o sound button
        let sound = .5;
        //variavel temporaria do set de carros para fazer o set temporário
        let carsSet = [0, 1, 2, 3];
        let switching = false;

        function atualizePosition()
        {   if(switching)
            {   if(buttons.length == 7)
                {   
                }

                if(buttons.length >= 24 && keys.includes(true))
                {   buttons[MenuOptions].text = "";
                    if(buttonsCanSwitch == buttonsSwitchLimit)
                    {   let playerPos = Math.trunc((MenuOptions)/6);
                        let newKey = keys.indexOf(true);
                        let keysT = ["up", "down", "left", "right", "frontShoot", "backShoot"];
                        for(let i = 0; (i < carsKeys.length); i++)
                        {   for(let i2 = 0; (i2 < keysT.length); i2++)
                            {   if(carsKeys[i][keysT[i2]] == newKey)
                                {   carsKeys[i][keysT[i2]] = "";
                                }
                            }
                        }
                        switch(MenuOptions%6)
                        {   case 0: 
                                carsKeys[playerPos].up = newKey;
                            break;
                            case 1: 
                                carsKeys[playerPos].down = newKey;
                            break;
                            case 2: 
                                carsKeys[playerPos].left = newKey;
                            break;
                            case 3: 
                                carsKeys[playerPos].right = newKey;
                            break;
                            case 4: 
                                carsKeys[playerPos].frontShoot = newKey;
                            break;
                            case 5: 
                                carsKeys[playerPos].backShoot = newKey;
                            break;
                        }
                        for(let i = 0; (i < buttons.length-1); i++)
                        {   let local = Math.trunc(i/6);
                            switch(i%6)
                            {   case 0:
                                    buttons[i].text = String.fromCharCode(carsKeys[local].up);
                                break;
                                case 1:
                                    buttons[i].text = String.fromCharCode(carsKeys[local].down);
                                break;
                                case 2:
                                    buttons[i].text = String.fromCharCode(carsKeys[local].left);
                                break;
                                case 3:
                                    buttons[i].text = String.fromCharCode(carsKeys[local].right);
                                break;
                                case 4:
                                    buttons[i].text = String.fromCharCode(carsKeys[local].frontShoot);
                                break;
                                case 5:
                                    buttons[i].text = String.fromCharCode(carsKeys[local].backShoot);
                                break;
                            }
                        }
                        buttonsCanSwitch = 0;
                        switching = false;
                    }
                }
            }
            else
            {   if(buttonsCanSwitch == buttonsSwitchLimit)
                {   if(buttons.length == 5)
                    {   if(MenuOptions != 4)
                        {   if(keys[39])
                            {   MenuOptions = (MenuOptions+1)%4
                                buttonsCanSwitch = 0; 
                            }
                            else
                            {   if(keys[37])
                                {   MenuOptions = (MenuOptions+3)%4
                                    buttonsCanSwitch = 0; 
                                }
                            }
                        }
                        if(keys[38] || keys[40])
                        {   MenuOptions = (!(Math.trunc(MenuOptions/4)))*4
                            buttonsCanSwitch = 0; 
                        }
                    }
                    else
                    { if(buttons.length >= 24)
                        {   if(MenuOptions == buttons.length-1 && (keys[39]+keys[40]+keys[37]+keys[38]))
                            {   MenuOptions = 0;
                                buttonsCanSwitch = 0;   
                            }
                            else if (MenuOptions == 0 && (keys[37]+keys[38]))
                            {   MenuOptions = buttons.length-1;
                                buttonsCanSwitch = 0;   
                            }
                            else
                            {   if(keys[37])
                                {   MenuOptions = (MenuOptions-6+(buttons.length-1))%(buttons.length-1);
                                    buttonsCanSwitch = 0;
                                }
                                else
                                {   if(keys[39])
                                    {   MenuOptions = (MenuOptions+6)%(buttons.length-1);
                                        buttonsCanSwitch = 0;
                                    }
                                }
                                if(keys[38])
                                {   if(Math.trunc(MenuOptions/6)*6==MenuOptions)
                                    {   MenuOptions = Math.ceil((MenuOptions+1)/6)*6-1;
                                    }
                                    else
                                    {   MenuOptions = (MenuOptions-1+(buttons.length-1))%(buttons.length-1);
                                    }
                                    buttonsCanSwitch = 0;
                                }
                                else
                                {   if(keys[40])
                                    {   if(Math.ceil(MenuOptions/6)*6-1==MenuOptions)
                                        {   MenuOptions = Math.trunc(MenuOptions/6)*6;
                                        }
                                        else
                                        {   MenuOptions = (MenuOptions+1)%(buttons.length-1);
                                        }
                                        buttonsCanSwitch = 0;
                                    }
                                }   
                            }
                        }
                        else
                        {   if(keys[38])
                            {   MenuOptions = (MenuOptions-1+buttons.length)%buttons.length;
                                buttonsCanSwitch = 0;
                            }
                            if(keys[40])
                            {   MenuOptions = (MenuOptions+1)%buttons.length;
                                buttonsCanSwitch = 0;
                            }
                            if(keys[39])
                            {   if(buttons[MenuOptions].text == playersQuantity + " PLAYERS" || buttons[MenuOptions].text == "SOM")
                                {   buttons[MenuOptions].clicked(1);
                                    buttonsCanSwitch = 0;
                                }
                            }
                            if(keys[37])
                            {   if(buttons[MenuOptions].text == playersQuantity + " PLAYERS" || buttons[MenuOptions].text == "SOM")
                                {   buttons[MenuOptions].clicked(-1);
                                    buttonsCanSwitch = 0;
                                }
                            }
                        }
                    }
                }
                if((keys[32] && buttonsCanSwitch == buttonsSwitchLimit) || (mouse.click && mouse.colliding) && !switching)
                {   let parameter;
                    if(buttons[MenuOptions].text == "SOM")
                    {   parameter = 0;
                    }
                    if((mouse.click && mouse.colliding) && buttons[MenuOptions].text == playersQuantity + " PLAYERS")
                    {   parameter = 1;
                    }
                    buttons[MenuOptions].clicked(parameter);
                    buttonsCanSwitch = 0;
                }
            }
            
            buttonsCanSwitch += buttonsCanSwitch < buttonsSwitchLimit;
            mouse.click = false;
        }
        function menu()
        {   context.drawImage(menu_background, 0, 0, canvas.width, canvas.height);
            if(buttons[0].text == "PLAYER 1")
            {   let carsImgs = [new Image(), new Image(), new Image(), new Image()];
                for(let i = 0; (i < carsImgs.length); i++)
                {   switch (carsSet[i])        
                    {   case 0:
                            carsImgs[i].src = "imgs/cars/viper.png";
                        break;
                        case 1:
                            carsImgs[i].src = "imgs/cars/challenger.png";
                        break;
                        case 2:
                            carsImgs[i].src = "imgs/cars/ranger.png";
                        break;
                        case 3:
                            carsImgs[i].src = "imgs/cars/vanderlei.png";
                        break;
                    }
                }
                
                context.fillStyle = "black";
                for(let i = 0; (i < carsImgs.length); i++)
                {   context.fillRect(buttons[i].x, buttons[i].y+125, buttons[i].width, buttons[i].width+50)
                    context.save();
                    context.translate(buttons[i].x+buttons[i].width/2, buttons[i].y+buttons[i].height/2)
                    context.rotate(Math.PI*1.5)
                    context.drawImage(carsImgs[i], -buttons[i].width-100, -buttons[i].height/2, buttons[i].width, buttons[i].height);
                    context.restore();
                }
            }
            else
            {   if(buttons.length < 24)
                {   context.fillStyle = "white";
                    context.font = "100px Times new Roman"
                    context.fillText("DEATH RALLY", 400, 160);
                    context.fillText("(só que ruim)", 400, 260);                
                }
            }
            
            atualizeButtons();
            atualizePosition();
            
            if(buttons.length >= 24)
            {   context.fillStyle = "white";
                context.font = (canvas.width+canvas.height)/105+"px Times New Roman";
                
                context.fillText("CIMA:", canvas.width*.32, canvas.height*.175);
                context.fillText("BAIXO:", canvas.width*.32, canvas.height*.325);
                context.fillText("ESQUERDA:", canvas.width*.32, canvas.height*.475);
                context.fillText("DIREITA:", canvas.width*.32, canvas.height*.625);
                context.fillText("ARMA FRONTAL:", canvas.width*.32, canvas.height*.775);
                context.fillText("ARMA TRASEIRA:", canvas.width*.32, canvas.height*.925);
                context.textAlign = "left";
                context.fillText("PLAYER 1", canvas.width*.415, canvas.height*.075);
                context.fillText("PLAYER 2", canvas.width*.565, canvas.height*.075);
                context.fillText("PLAYER 3", canvas.width*.715, canvas.height*.075);
                context.fillText("PLAYER 4", canvas.width*.865, canvas.height*.075);
            }
        }
        function atualizeButtons()
        {   for(let i = 0; (i < buttons.length); i++)
            {   buttons[i].draw()    
                if(i == MenuOptions)   
                {   buttons[i].selected = true;
                }
                else
                {  buttons[i].selected = false; 
                }
            }
            
        }
        function loop() {
            // context.fillStyle = 'darkgreen';
            // context.fillRect(0, 0, canvas.width, canvas.height);
            // context.drawImage(world.pista, 0, 0, world.width, world.height);
            // for(let i = 0; (i < cameras.length); i++)
            // {   cameras[i].update();
            //     cameras[i].draw();
            // }
            players.update();
            for(let i = 0; (i < cameras.length); i++)
            {   cameras[i].update();
                cameras[i].draw();
            }
        }

        document.addEventListener("keydown", keyD);
        document.addEventListener("keyup", keyU);
        document.addEventListener("mousemove", mouseM);
        function keyD(event)
        {   keys[event.keyCode] = true;
            console.log(event.keyCode);
        }
        function keyU(event)
        {   keys[event.keyCode] = false;
        }
        function mouseM(event)
        {   mouse.x = event.clientX;
            mouse.y = event.clientY;
            for(let i = 0; (i < buttons.length) && (!switching); i++)
            {   if(mouse.collide(buttons[i]))
                {   MenuOptions = i;
                    mouse.colliding = true;
                    i = buttons.length;
                }   
                else
                {   mouse.colliding = false;
                }
            }
        }

        document.addEventListener("click", clicked);
        function clicked()
        {   mouse.click = true;
        }

    </script>
</body>

</html>

<!-- 
        Telas: 

    Tela Inicial

    Options

    Jogo

        Classes:

    base
Imagem                                                                      X
    
Pontos                                                                      X
Colisão - Jeffrey Thompson                                                  X
Draw com rotate
Draw de debug                                                               

    Hud                                                                     X

    Carro -- Gabriel                                                        X

    Tiros -- Bruno
--colisão fantasma (ponto central a ponto central na colisão)

    PowerUps

    Particulas                                                              X
Troca de sprites
    
    Cameras                                                                 x
Slow motion quando morrer / rewind


    Sons

        Se der:

    Controlador Universal

        Obstáculos

    Poça
    Caixote
    

    
-->

<!-- 
1:

    new Point(1859, 1807),
    new Point(1870, 1832),
    new Point(1897, 1831),
    new Point(1898, 1800),
    new Point(1878, 1794),
    new Point(1860, 1807)

2:

    new Point(967, 315),new Point(843, 320),new Point(727, 418),new Point(420, 726),new Point(402, 772),new Point(398, 1306),new Point(383, 1320),new Point(368, 1320),new Point(354, 1306),new Point(354, 266),new Point(995, 266),new Point(1019, 291),new Point(1021, 1387),new Point(1034, 1422),new Point(1059, 1457),new Point(1091, 1488),new Point(1128, 1507),new Point(1203, 1513),new Point(1459, 1513),new Point(1459, 1504),new Point(2510, 1504),new Point(2510, 1591),new Point(2307, 1592),new Point(2265, 1613),new Point(2216, 1663),new Point(2196, 1701),new Point(2190, 1709),new Point(2188, 1724),new Point(2188, 1730),new Point(2188, 2620),new Point(2185, 2637),new Point(2176, 2642),new Point(2155, 2647),new Point(1879, 2647),new Point(1859, 2627),new Point(1876, 2610),new Point(2187, 2610)

3:

    new Point(967, 505),new Point(925, 514),new Point(911, 522),new Point(611, 820),new Point(592, 863),new Point(590, 1391),new Point(587, 1410),new Point(573, 1432),new Point(511, 1495),new Point(468, 1509),new Point(441, 1513),new Point(281, 1514),new Point(241, 1498),new Point(216, 1475),new Point(174, 1425),new Point(161, 1407),new Point(159, 253),new Point(211, 191),new Point(268, 136),new Point(349, 87),new Point(391, 76),new Point(1084, 75),new Point(1120, 79),new Point(1200, 154),new Point(1212, 188),new Point(1217, 206),new Point(1217, 1290),new Point(1246, 1322),new Point(3066, 1306),new Point(3086, 1288),new Point(3086, 617),new Point(3059, 593),new Point(3026, 593),new Point(2981, 606),new Point(2959, 621),new Point(2929, 652),new Point(2914, 667),new Point(2847, 731),new Point(2853, 930),new Point(2981, 1057)

4:

    new Point(857, 313),new Point(1475, 313),new Point(1539, 349),new Point(1585, 402),new Point(1596, 451),new Point(1596, 623),new Point(1589, 649),new Point(1544, 697),new Point(1472, 770),new Point(1394, 853),new Point(1370, 873),new Point(1340, 883),new Point(1320, 886),new Point(948, 889),new Point(931, 910),new Point(923, 956),new Point(926, 1040),new Point(934, 1062),new Point(945, 1072),new Point(970, 1081),new Point(1002, 1083),new Point(1008, 1079),new Point(1211, 1080),new Point(1211, 1110),new Point(1693, 1113),new Point(1693, 866),new Point(1708, 821),new Point(1733, 790),new Point(1779, 750),new Point(1825, 733),new Point(3392, 733),new Point(3423, 742),new Point(3482, 788),new Point(3515, 838),new Point(3520, 860),new Point(3521, 1133),new Point(3512, 1157),new Point(3506, 1175),new Point(3494, 1195),new Point(3466, 1221),new Point(3448, 1240),new Point(3407, 1258),new Point(3397, 1264),new Point(2934, 1265),new Point(2904, 1255),new Point(2880, 1246),new Point(2872, 1240),new Point(2610, 976),new Point(2604, 976),new Point(2501, 1082),new Point(2490, 1091),new Point(2473, 1105),new Point(2461, 1124),new Point(2429, 1156),new Point(2384, 1202),new Point(2338, 1244),new Point(2322, 1255),new Point(2297, 1261),new Point(2094, 1265),new Point(2022, 1249),new Point(1980, 1221),new Point(1950, 1182),new Point(1936, 1141),new Point(1932, 1122),new Point(1934, 540),new Point(1956, 478),new Point(1989, 441),new Point(2032, 408),new Point(2058, 399),new Point(2288, 399),new Point(2334, 416),new Point(2344, 424),new Point(2605, 686),new Point(2901, 402),new Point(3149, 402),new Point(3186, 413),new Point(3234, 448),new Point(3263, 485),new Point(3277, 518),new Point(3280, 524),new Point(3279, 1378),new Point(3265, 1418),new Point(3251, 1443),new Point(3221, 1466),new Point(3200, 1487),new Point(3173, 1496),new Point(3153, 1504),new Point(2930, 1505),new Point(2930, 1596),new Point(3030, 1598),new Point(3070, 1616),new Point(3097, 1635),new Point(3136, 1672),new Point(3282, 1818),new Point(3292, 1860),new Point(3299, 1925),new Point(3300, 1943),new Point(3299, 2193),new Point(3282, 2232),new Point(3254, 2267),new Point(3211, 2306),new Point(3160, 2318),new Point(2901, 2317),new Point(2871, 2312),new Point(2836, 2290),new Point(2590, 2042),new Point(2541, 2029),new Point(2098, 2030),new Point(2098, 2088),new Point(2109, 2107),new Point(2132, 2119),new Point(2532, 2121),new Point(2571, 2132),new Point(2614, 2158),new Point(2655, 2195),new Point(2668, 2238),new Point(2675, 2322),new Point(2675, 2410),new Point(3172, 2411),new Point(3207, 2420),new Point(3234, 2440),new Point(3278, 2487),new Point(3292, 2528),new Point(3299, 2593),new Point(3299, 2717),new Point(3284, 2756),new Point(3251, 2797),new Point(3220, 2826),new Point(3195, 2839),new Point(3156, 2846),new Point(2620, 2846),new Point(2579, 2838),new Point(2547, 2819),new Point(2516, 2788),new Point(2486, 2749),new Point(2476, 2721),new Point(2480, 2606),new Point(1873, 2606),new Point(1858, 2624),new Point(1859, 2637),new Point(1873, 2650),new Point(2161, 2650),new Point(2184, 2636),new Point(2191, 2616),new Point(2192, 2606)
-->